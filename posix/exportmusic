#!/bin/bash

# Export music directories marked with "export" to MP3, "export-alac" to 
# ALAC M4A

if [ "$1" == "-v" ]; then
    set -x
    shift
fi

if [ $# != 2 ]; then
    echo "exportmusic: Usage: exportmusic [-v] src_dir dst_dir"
    exit 1
fi

src="$1"
dst="$2"
lock=~/.exportmusic.lock

lockfile -r 0 "$lock" || exit 1
trap "rm -f $lock; exit" INT TERM EXIT

for artistDir in $src/*; do
    artist=${artistDir##*/}
    if [ "$artist" == "random" ]; then
        continue
    fi
    if [ ! -d "$artistDir" ]; then
        continue
    fi

    for albumDir in "$artistDir"/*; do
        if [ ! -d "$albumDir" ]; then
            continue
        fi
        if [ -f "$albumDir"/export-alac ]; then
            lossless=1
        elif [ -f "$albumDir"/export ]; then
            lossless=0
        else
            continue
        fi

        album=`basename "$albumDir"`
        dstDir="$dst"/"$artist"/"$album"
        mkdir -p "$dstDir"

        # Convert flacs to mp3s or m4as
        track=0
        ls "$albumDir"/*.flac 2>/dev/null | \
        while read flacFile; do
            track=`expr $track + 1`
            if [ ! -f "$flacFile" ]; then
                continue
            fi
            title=`basename "$flacFile"`
            title=${title%%.flac}
            mp3File="$title".mp3
            alacFile="$title".m4a
            if [ $lossless = 0 ]; then
                if [ -f "$dstDir"/"$mp3File" ]; then
                    continue
                fi
                echo "$flacFile -> $dstDir/$mp3File"
                rm -f "$dstDir"/"$alacFile"
                flac --totally-silent -c -d "$flacFile" | \
                lame --preset extreme -S --tt "$title" --ta "$artist" \
                    --tl "$album" --tn "$track" - "$dstDir"/"$mp3File" \
                    >/dev/null 2>&1
            else
                if [ -f "$dstDir"/"$alacFile" ]; then
                    continue
                fi
                echo "$flacFile -> $dstDir/$alacFile"
                rm -f "$dstDir"/"$mp3File"
                flac --totally-silent -o /tmp/x.wav -c -d "$flacFile"
                ffmpeg -i /tmp/x.wav -acodec alac \
                    -v 0 \
                    -metadata title="$title" \
                    -metadata author="$artist" \
                    -metadata album_artist="$artist" \
                    -metadata album="$album" \
                    -metadata track="$track" \
                    "$dstDir"/"$alacFile" </dev/null 2>/dev/null
                rm -f /tmp/x.wav
            fi
        done

        # Convert wavs to mp3s or m4as
        ls "$albumDir"/*.wav 2>/dev/null | \
        while read wavFile; do
            if [ ! -f "$wavFile" ]; then
                continue
            fi
            title=`basename "$wavFile"`
            title=${title%%.wav}
            mp3File="$title".mp3
            alacFile="$title".m4a
            trackNo=`echo "$title"|awk '{print int("1" $1)-100}' 2>/dev/null`
            if [ $lossless = 0 ]; then
                if [ -f "$dstDir"/"$mp3File" ]; then
                    continue
                fi
                echo "$wavFile -> $dstDir/$mp3File"
                rm -f "$dstDir"/"$alacFile"
                lame --preset extreme -S --tt "$title" --ta "$artist" \
                    --tn "$trackNo" --tl "$album" \
                    "$wavFile" "$dstDir"/"$mp3File" >/dev/null 2>&1
             else
                if [ -f "$dstDir"/"$alacFile" ]; then
                    continue
                fi
                echo "$wavFile -> $dstDir/$alacFile"
                rm -f "$dstDir"/"$mp3File"
                flac --totally-silent -o /tmp/x.wav -c -d "$flacFile"
                ffmpeg -i "$wavFile" -acodec alac \
                    -v 0 \
                    -metadata title="$title" \
                    -metadata author="$artist" \
                    -metadata album_artist="$artist" \
                    -metadata album="$album" \
                    -metadata track="$track" \
                    "$dstDir"/"$alacFile" </dev/null 2>/dev/null
                :
             fi
        done

        # Convert oggs to mp3s or m4as
        ls "$albumDir"/*.ogg 2>/dev/null | \
        while read oggFile; do
            if [ ! -f "$oggFile" ]; then
                continue
            fi
            title=`basename "$oggFile"`
            title=${title%%.ogg}
            mp3File="$title".mp3
            alacFile="$title".m4a
            trackNo=`echo "$title"|awk '{print int("1" $1)-100}' 2>/dev/null`
            if [ $lossless = 0 ]; then
                if [ -f "$dstDir"/"$mp3File" ]; then
                    continue
                fi
                echo "$oggFile -> $dstDir/$mp3File"
                rm -f "$dstDir"/"$alacFile" "dstDir/$title.ogg"
                oggdec --quiet -o /tmp/x.wav "$oggFile"
                lame --preset extreme -S --tt "$title" --ta "$artist" \
                    --tn "$trackNo" --tl "$album" \
                    /tmp/x.wav "$dstDir"/"$mp3File" >/dev/null 2>&1
                rm -f /tmp/x.wav
            else
                if [ -f "$dstDir"/"$alacFile" ]; then
                    continue
                fi
                echo "$oggFile -> $dstDir/$alacFile"
                rm -f "$dstDir"/"$mp3File" "$dstDir"/"$title.ogg"
                oggdec --quiet -o /tmp/x.wav "$oggFile"
                ffmpeg -i /tmp/x.wav -acodec alac \
                    -v 0 \
                    -metadata title="$title" \
                    -metadata author="$artist" \
                    -metadata album_artist="$artist" \
                    -metadata album="$album" \
                    -metadata track="$track" \
                    "$dstDir"/"$alacFile" </dev/null 2>/dev/null
                rm -f /tmp/x.wav
            fi
        done

        # Copy mp3s
        ls "$albumDir"/*.mp3 2>/dev/null | \
        while read srcFile; do
            if [ ! -f "$srcFile" ]; then
                continue
            fi
            mp3File=`basename "$srcFile"`
            if [ -f "$dstDir"/"$mp3File" ]; then
                continue
            fi
            echo "$srcFile -> $dstDir/$mp3File"
            cp -f "$srcFile" "$dstDir"
        done
    done
done

# chown -R polster "$dst"/
chmod -R ug+rwx,o+rx "$dst"/
